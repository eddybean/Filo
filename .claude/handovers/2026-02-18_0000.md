# セッション引き継ぎノート 2026-02-18

## 今回やったこと

- **ソフトウェア仕様策定**: Filo の全体仕様を `docs/SPEC.md` として作成・レビュー・確定
  - ルールセット YAML 構造、画面ワイヤーフレーム、バックエンド仕様、i18n 仕様
- **開発環境構築**: Ubuntu 24.04 (WSL) 上に Tauri v2 + React 19 + TypeScript 環境を構築
- **Rust バックエンド実装 (TDD)**:
  - `ruleset.rs` — 型定義・YAML 処理・バリデーション（11テスト）
  - `filters.rs` — フィルタロジック（11テスト）
  - `engine.rs` — ファイル移動/コピーエンジン・Undo（12テスト）
  - `commands.rs` — Tauri IPC コマンド 10本
- **React フロントエンド実装**:
  - コンポーネント: Toolbar, RulesetCard, RulesetList, RulesetEditDialog, ExecutionResultDialog, App
  - Zustand ストア、Tauri コマンドラッパー、i18n (ja/en)、型定義
- **Windows 向け開発スクリプト作成**: setup.bat, setup.ps1, dev.bat, build.bat, test.bat
- **クロスプラットフォーム品質ツール導入**:
  - `.gitattributes` — 改行コード LF 統一、.bat/.ps1 は CRLF
  - `.editorconfig` — エディタ設定統一
  - Prettier + `.prettierrc` + `.prettierignore` — フロントエンドフォーマッタ
  - ESLint (`eslint.config.js`) — フロントエンドリンター
  - `rustfmt.toml` — Rust フォーマッタ
  - clippy — Rust リンター（警告修正済み）
  - lint-staged — npm scripts 更新
- **clippy 警告修正**: `commands.rs` の冗長クロージャを修正 `.map(|r| engine::execute_ruleset(r))` → `.map(engine::execute_ruleset)`

## 決定事項

- **技術スタック**: Tauri v2 + React 19 + TypeScript + Zustand + react-i18next + Tailwind CSS v4 + @dnd-kit
- **ルールセット保存形式**: YAML（`%APPDATA%/filo/rulesets/filo-rules.yaml`）
- **フィルタ結合ルール**: フィルタ条件は AND 結合、extensions 内部は OR 結合
- **id**: UUID v4 で自動生成、YAML にも永続化
- **order**: 不要（YAML 配列の順序で管理）
- **Action フィールド**: Move / Copy を選択可能
- **Undo**: Move アクションのみ対応、ダイアログセッション内のみ有効
- **i18n**: 日本語（デフォルト）+ 英語
- **改行コード**: LF 統一（.bat/.ps1 のみ CRLF）
- **TDD**: テストファースト、DEVLOG 記録

## 捨てた選択肢と理由

- **Electron**: バンドルサイズが大きくリソース消費も多い。Tauri v2 の方が軽量
- **Svelte/Vue**: React の方がエコシステムが充実、ユーザの要件に合致
- **クロスコンパイル (Linux → Windows exe)**: Tauri は WebView2 依存のため不可能。GitHub Actions または Windows 実機でのビルドが必要
- **husky (git hooks)**: lint-staged のみ導入し、husky は明示的に導入しなかった（必要に応じて後から追加可能）

## ハマりどころ

- **`npm create tauri-app`**: 既存ファイルがあるディレクトリでは実行不可。`/tmp` に作成してコピーで解決
- **PATH 問題**: WSL の bash で `$HOME/.cargo/bin` が PATH に入っていない場合がある。直接パスを指定するか `export PATH` で対処
- **tauri.conf.json の dialog プラグイン設定**: `"plugins": { "dialog": {} }` を書くとデシリアライズエラー（"invalid type: map, expected unit"）。`plugins` セクション自体を削除で解決
- **ESLint peer dependency 競合**: `--legacy-peer-deps` フラグで解決
- **Rust borrow checker**: `commands.rs` の `update_and_save` で guard のライフタイム問題。Mutex ロックを2回に分割して解決

## 学び

- Tauri v2 の dialog プラグインは `tauri.conf.json` に設定エントリ不要（空マップでもエラーになる）
- Tauri はクロスコンパイル非対応。ターゲット OS 上でビルドが必要
- `fs::rename` はクロスファイルシステムで失敗する。copy + delete のフォールバックが必要
- clippy の `-D warnings` フラグで警告をエラーとして扱える

## 次にやること

1. **husky + lint-staged の pre-commit hook 設定**（任意）— git commit 時に自動フォーマット実行
2. **フロントエンドテストの拡充** — 現在 `types.test.ts` の2テストのみ。コンポーネントテスト追加
3. **UI の動作確認・デバッグ** — `npm run tauri dev` で実際の画面を確認（Windows 環境推奨）
4. **GitHub Actions CI/CD** — Windows 向け自動ビルド・テスト・リリースパイプライン
5. **DEVLOG.md の更新** — クロスプラットフォームツール導入フェーズの記録

## 関連ファイル

### 設定・ドキュメント
- `CLAUDE.md`
- `docs/SPEC.md`
- `docs/DEVLOG.md`

### Rust バックエンド
- `src-tauri/Cargo.toml`
- `src-tauri/tauri.conf.json`
- `src-tauri/src/lib.rs`
- `src-tauri/src/ruleset.rs`
- `src-tauri/src/filters.rs`
- `src-tauri/src/engine.rs`
- `src-tauri/src/commands.rs`
- `src-tauri/rustfmt.toml`

### React フロントエンド
- `src/App.tsx`
- `src/components/Toolbar.tsx`
- `src/components/RulesetCard.tsx`
- `src/components/RulesetList.tsx`
- `src/components/RulesetEditDialog.tsx`
- `src/components/ExecutionResultDialog.tsx`
- `src/store/rulesetStore.ts`
- `src/lib/types.ts`
- `src/lib/commands.ts`
- `src/lib/i18n.ts`
- `src/lib/types.test.ts`
- `src/locales/ja/translation.json`
- `src/locales/en/translation.json`

### 品質ツール・設定
- `.gitattributes`
- `.editorconfig`
- `.prettierrc`
- `.prettierignore`
- `eslint.config.js`
- `vite.config.ts`

### スクリプト
- `scripts/setup.bat`
- `scripts/setup.ps1`
- `scripts/setup.sh`
- `scripts/dev.bat`
- `scripts/build.bat`
- `scripts/test.bat`
- `scripts/test.sh`
