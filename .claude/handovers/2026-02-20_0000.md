# セッション引き継ぎノート — 2026-02-20

## 今回やったこと

- `src-tauri/src/engine.rs` のファイル移動・コピー処理を堅牢化
- TDD で実施：テスト先行（失敗確認）→ 実装 → 全件通過の順で進行
- `docs/SPEC.md` に今回の変更内容を反映

### 実装内容（engine.rs）

追加したヘルパー関数：
- `is_cross_device_error(err)` — `rename` 失敗がクロスデバイス起因かを判定（`io::ErrorKind::CrossesDevices`）
- `copy_and_verify(src, dest)` — コピー後にバイト数検証、失敗・不一致時は残骸ファイルを削除
- `move_file(src, dest)` — `rename` 試行、クロスデバイスエラー時のみ `copy_and_verify + remove_file` にフォールバック
- `classify_io_error(e)` — エラー種別（PermissionDenied / StorageFull / NotFound / CrossesDevices）を識別してメッセージ生成

変更箇所：
- `execute_ruleset` の Move/Copy 実行部を `move_file` / `copy_and_verify` に置き換え
- エラーメッセージを `classify_io_error` に統一
- `undo_file_move` の移動操作を `move_file` に統一

テスト：34件 → 48件（+14件）

### SPEC.md 反映箇所

- 4.1 ファイル操作エンジン フロー（ステップ 5 を詳細化）
- 4.1 Undo処理フロー（`move_file` を使う旨を明記）
- 7.1 Rust テスト件数 34件 → 48件
- 8. 非機能要件に「移動の整合性」「クロスデバイス移動」「エラー識別」を追加

---

## 決定事項

- **事前容量チェックは実装しない**：TOCTOU 問題があるため。失敗時クリーンアップで代替
- **ネットワーク再試行ロジックは実装しない**：要件外・過剰エンジニアリング
- **クロスデバイスエラー判定**：`io::ErrorKind::CrossesDevices`（Rust 1.75+で安定化、環境は1.93.1）を使用。`raw_os_error()` による判定は不要
- **サイズ不一致検証**：`fs::copy` の戻り値（コピー済みバイト数）と `fs::metadata(src).len()` を比較
- **依存クレート追加なし**：`std::io` の追加のみで実現

---

## 捨てた選択肢と理由

| 選択肢 | 不採用理由 |
|--------|----------|
| 事前ディスク容量チェック | TOCTOU 問題（チェック後に空き容量が変わる可能性）。コピー後検証で十分 |
| ハッシュ（SHA256等）による整合性検証 | 大ファイルでの性能劣化が大きい。バイト数一致で実用上十分 |
| ネットワーク切断時のリトライロジック | 要件に含まれず、複雑性が上がる。エラーとして記録し継続する方針と合致しない |
| `raw_os_error() == Some(17)` でのクロスデバイス判定 | Rust 1.75+ では `ErrorKind::CrossesDevices` が使えるため不要 |
| `fs_extra` や `walkdir` クレートの導入 | 標準ライブラリだけで要件を満たせるため不必要に依存を増やさない |

---

## ハマりどころ

- `test_copy_and_verify_cleans_up_on_error` のテスト名が誤解を招く内容だった
  - src が存在しない場合は `fs::metadata` で早期失敗するため `fs::copy` 自体は呼ばれない
  - 「`fs::copy` 失敗時の残骸クリーンアップ」をテストするには別の手法が必要
  - → 親ディレクトリが存在しない dest パスを指定して `fs::copy` 失敗を誘発する `test_copy_and_verify_cleans_up_when_dest_parent_missing` を別途追加

---

## 学び

- `fs::copy` の戻り値は `u64`（コピー済みバイト数）であり、これを使った整合性検証は追加コストなしで実現可能
- `io::ErrorKind::CrossesDevices` は Rust 1.75 で安定化。Windows の `ERROR_NOT_SAME_DEVICE (17)` と Linux の `EXDEV (18)` 両方に対応済み
- `or_else(|_|)` でエラーを捨てるパターンは「エラー種別を無視したフォールバック」を生み出す危険なパターン
- `test_execute_ruleset_partial_failure_status` を書く際、宛先に同名のディレクトリを作ることでファイル操作を確実に失敗させられる

---

## 次にやること

- 特になし（今回の作業は完結）

将来的な検討候補：
- エラーメッセージの i18n 対応（現在は英語固定）
- 実行結果ダイアログでのエラー種別の表示改善（現在の raw な文字列をより分かりやすく）

---

## 関連ファイル

- `src-tauri/src/engine.rs` — 主な変更先（ヘルパー関数追加・テスト追加）
- `docs/SPEC.md` — 仕様書の更新
