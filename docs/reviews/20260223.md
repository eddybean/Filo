# 構成コードレビューレポート

**日付**: 2026-02-23  
**対象**: Filo プロジェクト全体 (Tauri + React)

本レポートは、`docs/SPEC.md` の仕様に従ったコードベース全体の静的解析と論理確認に基づき、**高信頼度のバグ・パフォーマンス懸念・テスト不足**に絞って出力したものです。

## 1. 発見されたバグ・論理的欠陥

### 1-1. 日付フィルタにおける無効な日時のサイレント無視
- **対象ファイル**: `src-tauri/src/filters.rs`, `src-tauri/src/ruleset.rs`
- **問題の詳細**: 
  `filters.rs` の `match_datetime_range` 内において、`DateTime::parse_from_rfc3339` がパースエラー（`Err`）を返した場合、そのエラーを無視して処理を続行し、最終的に `true` を返してしまう実装になっています（実質的にそのフィルタ条件が存在しないのと同じ扱いになります）。
  さらに、`ruleset.rs` の `Ruleset::validate()` においても、保存時に `created_at` および `modified_at` の値が有効な RFC3339 形式であるかの妥当性検査が行われていません。
- **推奨する修正**: 
  バックエンドのバリデーション時に日付形式のパースを行い不正な場合は保存させないこと。かつ、実行時 (`match_datetime_range`) にパースに失敗した場合はマッチング失敗 (`false`) を返すよう厳密に処理するべきです。フロントエンドの `RulesetEditDialog.tsx` においても「開始日時 ≦ 終了日時」という整合性チェックを追加することを推奨します。

### 1-2. JS正規表現変換（フロントエンド）の考慮漏れ
- **対象ファイル**: `src/components/RegexTesterPanel.tsx`
- **問題の詳細**:
  `buildJsRegex` 関数内で Rust における否定文字クラス `[^]` 構文を JavaScript に適合させるために `pattern.replace(/\[\^\]]/g, "[^\\]]")` を行っています。しかしこれは `[^]]` という完全一致文字列に対してしか機能しません。例えば `[^]A-Z]` （`]` または A-Z 以外の文字）といった応用的な記述をユーザーが行った場合、置換が適用されず、JS の `Regex` エンジン上で構文エラーとなるか、Rust上の実行結果と異なる動き（テスター画面でのマッチ結果の乖離）を招きます。

## 2. パフォーマンスに関する重大な懸念

### 2-1. ループ内での正規表現再コンパイル
- **対象ファイル**: `src-tauri/src/engine.rs` (`resolve_destination_template`), `src-tauri/src/filters.rs` (`extract_named_captures`)
- **問題の詳細**:
  `execute_ruleset` において数万規模のファイルをスキャンする可能性がありますが、その走査ループごとに `regex::Regex::new()` が呼び出されています。
  1. `has_template_vars` が真の場合に呼ばれる `extract_named_captures` にて、毎ファイル `pattern` を複数回コンパイルしています。
  2. `resolve_destination_template` 内で静的なパターン `r"\{([^}]+)\}"` を、解決関数呼び出しごとに毎度コンパイルしています。
- **推奨する修正**: 
  静的なテンプレート変数の抽出パターンは `std::sync::OnceLock` (または `lazy_static`) を利用してグローバルでコンパイルキャッシュを行ってください。動的な `pattern` についてもループの先頭（ファイル列挙後）で1度だけコンパイルし、その `Regex` インスタンスを各ファイルのマッチング関数に渡し使い回すように設計を修正するべきです。

## 3. テストケースの十分性評価

全体的に見ると、ファイル操作（`move`/`copy`）、クロスデバイスのフォールバック・上書き可否、バックグラウンドでのキャンセル処理（`cancel_execution` とフラグ伝播）、テンプレート変数の解決（`resolve_destination_template`）など、重要ドメインロジックに関するテストは十分に定義されており、**Layer 1 (Rust)・Layer 2 (Vitest) の両方で高いカバレッジを示していると評価できます**。

ただし、以下のエッジケースに関してテストが不足しています。

1. **日時のパースエラーテスト**
   - 今回のバグ（1-1）に絡むものですが、意図的に無効な文字列（`"invalid"` など）が YAML からロードされ `created_at` や `modified_at` フィルタに渡された場合の動作を担保するテストケースが存在しません。
2. **Action::Copy時の上書きスキップ判定テスト**
   - ファイル Action が `Copy` かつ `overwrite=false` に設定されており、移動先に同名ファイルが既に存在する場合に、正しくスキップ（ファイルの保護）が行われるかどうかのテスト（`Move` 時の `test_skip_when_overwrite_disabled` に相当するテスト）が欠落しています。

---
**総評**: コアの仕様とバックエンドのファイル安全保護機能は非常に堅牢ですが、実運用での大量ファイル処理や不正データ入力に対するエッジケースの考慮（特に正規表現のコストと日付のバリデーション）において最適化と修正が必要です。
